<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Loan & BTC DCA Calculator</title>
  <style>
    :root {
      --bg:#0f172a;
      --panel:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --brand:#22d3ee;
      --accent:#a78bfa;
      --error:#f43f5e;
      --ok:#34d399;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:linear-gradient(135deg,var(--bg),#020617);color:var(--text)}
    .wrap{max-width:980px;margin:40px auto;padding:24px}
    .card{background:rgba(17,24,39,.75);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.06);border-radius:18px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{font-size:clamp(22px,3.2vw,32px);margin:0 0 8px 0}
    h2{font-size:clamp(18px,2.6vw,24px);margin:14px 0 8px}
    p.lead{margin:0 0 18px 0;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}
    label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
    input,button,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0b1220;color:var(--text);font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{cursor:pointer;border:none}
    .btn-primary{background:linear-gradient(90deg,var(--brand),var(--accent));color:#001018;font-weight:700}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.12)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);cursor:pointer;color:var(--text);background:#0b1220}
    .chip:hover{border-color:var(--brand)}
    .chip.active{background:#1f2a44;border-color:var(--accent)}
    .muted{color:var(--muted)}
    .splitLive{color:var(--accent);font-weight:700;font-size:clamp(16px,2.2vw,18px)}
    .result{margin-top:14px;padding:14px;border-radius:14px;background:#0a1426;border:1px solid rgba(255,255,255,.06)}
    .result h3{margin:0 0 8px 0;font-size:16px;color:#c7d2fe}
    .stat{display:grid;grid-template-columns:1fr auto;gap:10px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
    .stat:last-child{border-bottom:none}
    .ok{color:var(--ok)}
    .err{color:var(--error)}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media (max-width:820px){.col-6,.col-8,.col-4{grid-column:span 12}}
    .tests{margin-top:18px;padding:12px;border-radius:12px;background:#0b1220;border:1px dashed rgba(255,255,255,.12);font-size:14px}
    .tests .pass{color:var(--ok)}
    .tests .fail{color:var(--error)}
    .note{font-size:13px;color:var(--muted);margin-top:6px;line-height:1.4}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Loan & BTC DCA Calculator</h1>
      <p class="lead">Enter your loan details first, then choose how to split your monthly budget between loan repayments and BTC DCA. BTC horizon auto‑aligns with the loan payoff.</p>

      <!-- Loan Inputs moved ABOVE Budget Split -->
      <h2>Loan Inputs</h2>
      <div class="grid">
        <div class="col-6">
          <label for="balance">Starting balance (£)</label>
          <input id="balance" type="number" inputmode="decimal" step="0.01" value="10000" />
        </div>
        <div class="col-6">
          <label for="lump">Optional lump sum at start (£)</label>
          <input id="lump" type="number" inputmode="decimal" step="0.01" value="0" />
        </div>
      </div>

      <h2>Budget Split</h2>
      <div class="grid">
        <div class="col-6">
          <label for="budget">Monthly budget (£)</label>
          <input id="budget" type="number" step="0.01" value="250" />
        </div>
        <div class="col-6">
          <label for="split">Split to Loan (%)</label>
          <input id="split" type="range" min="0" max="100" step="1" value="50" />
          <div class="row" style="justify-content:space-between;align-items:center;margin-top:6px">
            <span id="splitLive" class="splitLive">Loan 50% / BTC 50%</span>
            <button id="preset5050" class="chip" type="button" title="Set split to 50/50">50/50 Split</button>
          </div>
        </div>
        <div class="col-6">
          <label>Monthly to Loan (£)</label>
          <div id="monthlyLoan" class="splitLive">£494.29</div>
        </div>
        <div class="col-6">
          <label>Monthly to BTC (£)</label>
          <div id="monthlyBTC" class="splitLive">£494.29</div>
        </div>
      </div>

      <h2>BTC DCA Inputs</h2>
      <div class="grid">
        <div class="col-6">
          <label for="btcGrowth">BTC annual growth %</label>
          <input id="btcGrowth" type="number" step="0.01" value="29" />
          <p class="note">These three scenarios reflect Michael Saylor’s long‑term BTC growth projections:</p>
          <div class="row" style="margin-top:6px;gap:8px">
            <button type="button" class="chip growth-btn" data-growth="21" title="Bear case">Bear 21%</button>
            <button type="button" class="chip growth-btn active" data-growth="29" title="Base/Moderate case">Base 29%</button>
            <button type="button" class="chip growth-btn" data-growth="37" title="Bull case">Bull 37%</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn btn-primary" id="calc">Calculate</button>
        <button class="btn btn-ghost" id="reset">Reset</button>
      </div>

      <div class="grid" style="margin-top:14px">
        <div class="col-12 col-6">
          <div class="result" id="loanResult" hidden>
            <h3>Loan Results</h3>
            <div class="stat"><span>Monthly to Loan</span><strong id="monthlyLoanOut">—</strong></div>
            <div class="stat"><span>Months to clear</span><strong id="monthsOut">—</strong></div>
            <div class="stat"><span>Years & months</span><strong id="ymOut">—</strong></div>
            <div class="stat"><span>Approx. payoff date</span><strong id="dateOut">—</strong></div>
            <div class="stat"><span>Total paid</span><strong id="paidOut">—</strong></div>
            <div class="stat"><span>Final partial payment (if any)</span><strong id="partialOut">—</strong></div>
          </div>
        </div>
        <div class="col-12 col-6">
          <div class="result" id="btcResult" hidden>
            <h3>BTC DCA Results</h3>
            <div class="stat"><span>Monthly to BTC</span><strong id="monthlyBTCOut">—</strong></div>
            <div class="stat"><span>Months contributed</span><strong id="btcMonths">—</strong></div>
            <div class="stat"><span>Years & months</span><strong id="btcYM">—</strong></div>
            <div class="stat"><span>Approx. payoff date</span><strong id="btcDateOut">—</strong></div>
            <div class="stat"><span>Total contributed</span><strong id="btcContrib">—</strong></div>
            <div class="stat"><span>Projected annual growth</span><strong id="btcGrowthOut">—</strong></div>
            <div class="stat"><span>Projected value at end</span><strong id="btcFV">—</strong></div>
          </div>
        </div>
        <div class="col-12">
          <div class="result" id="netResult" hidden>
            <h3>Net Wealth Projection</h3>
            <div class="stat"><span>Loan balance cleared?</span><strong id="loanCleared">—</strong></div>
            <div class="stat"><span>Total paid toward loan (to horizon)</span><strong id="netLoanPaid">—</strong></div>
            <div class="stat"><span>Projected BTC value</span><strong id="netBTCVal">—</strong></div>
            <div class="stat"><span>Combined net wealth (paid + BTC)</span><strong id="netCombined">—</strong></div>
          </div>
        </div>
      </div>

      <footer>
        Defaults: balance £56,484 (closing balance May 2025). <strong>Start dates default to the current month.</strong> BTC end date auto‑aligns with the loan payoff behind the scenes. Projection uses simple monthly compounding (no fees/taxes; GBP).
      </footer>

      <div class="tests" id="tests">
        <strong>Self‑tests</strong>
        <div id="testResults" class="muted">Running…</div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const formatCurrency = (n) => n.toLocaleString(undefined,{style:'currency',currency:'GBP',maximumFractionDigits:2});
    const round2 = (n) => Math.round((n + Number.EPSILON) * 100) / 100;

    const NOW = new Date();
    const DEFAULT_YM = `${NOW.getFullYear()}-${String(NOW.getMonth()+1).padStart(2,'0')}`; // e.g. 2025-09

    function addMonths(date, m){
      const d = new Date(date.getFullYear(), date.getMonth(), 1);
      d.setMonth(d.getMonth() + m);
      return d;
    }
    function diffMonths(a, b){
      return (b.getFullYear()-a.getFullYear())*12 + (b.getMonth()-a.getMonth());
    }
    function ymStr(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      return `${y}-${m}`;
    }

    // ---------- Loan maths (no interest) ----------
    function calculateLoan(balance, monthly, lump, startVal){
      balance = Math.max(0, Number(balance || 0));
      monthly = Math.max(0, Number(monthly || 0));
      lump = Math.max(0, Number(lump || 0));
      startVal = startVal || DEFAULT_YM;

      if(monthly <= 0){
        return { error: 'Monthly repayment must be greater than £0' };
      }

      let remaining = Math.max(0, round2(balance - lump));
      let months = 0;
      let totalPaid = round2(lump);
      let finalPartial = 0;

      if(remaining > 0){
        const fullMonths = Math.floor(remaining / monthly);
        const remainder = round2(remaining - round2(fullMonths * monthly));
        if(remainder === 0){
          months = fullMonths;
          totalPaid = round2(lump + fullMonths * monthly);
          finalPartial = 0;
        } else {
          months = fullMonths + 1;
          finalPartial = remainder;
          totalPaid = round2(lump + fullMonths * monthly + remainder);
        }
      }

      const years = Math.floor(months / 12);
      const extraMonths = months % 12;

      const [y, m] = startVal.split('-').map(Number);
      const startDate = new Date(y, (m-1), 1);
      const payoff = addMonths(startDate, months);
      const payoffStr = payoff.toLocaleString(undefined,{month:'short', year:'numeric'});

      return { months, years, extraMonths, payoffStr, totalPaid, finalPartial, payoffDate:payoff, startDate };
    }

    // How much of the loan is paid by t months from start
    function loanPaidBy(balance, monthly, lump, t){
      balance = Math.max(0, Number(balance||0));
      monthly = Math.max(0, Number(monthly||0));
      lump = Math.max(0, Number(lump || 0));
      const remaining = Math.max(0, round2(balance - lump));
      if(remaining <= 0) return round2(lump);
      const fullMonths = Math.floor(remaining / monthly);
      const remainder = round2(remaining - round2(fullMonths * monthly));
      const payoffMonths = fullMonths + (remainder>0 ? 1 : 0);
      if(t <= 0) return round2(lump);
      if(t < fullMonths) return round2(lump + t*monthly);
      if(t === fullMonths){
        return round2(lump + fullMonths*monthly);
      }
      if(t === payoffMonths){
        return round2(lump + fullMonths*monthly + (remainder||0));
      }
      if(t > payoffMonths){
        return round2(lump + fullMonths*monthly + (remainder||0));
      }
      return round2(lump + fullMonths*monthly);
    }

    // ---------- BTC DCA maths ----------
    function calculateBTC(monthlyGBP, annualPct, startVal, endVal){
      monthlyGBP = Math.max(0, Number(monthlyGBP || 0));
      const rAnnual = Math.max(0, Number(annualPct || 0))/100;
      const [ys, ms] = (startVal||DEFAULT_YM).split('-').map(Number);
      const start = new Date(ys, ms-1, 1);
      const end = endVal instanceof Date ? endVal : new Date(endVal+'-01');
      let n = diffMonths(start, end);
      if(n < 0) n = 0;

      const i = rAnnual/12; // monthly rate
      let fv = 0;
      if(i === 0){
        fv = monthlyGBP * n;
      } else {
        fv = monthlyGBP * ((Math.pow(1+i, n) - 1) / i);
      }

      const contrib = monthlyGBP * n;
      return { months:n, contrib, fv, annualPct:rAnnual*100, start, end };
    }

    // ---------- UI wiring ----------
    function updateSplit(){
      const budget = Number(document.getElementById('budget').value||0);
      const split = Number(document.getElementById('split').value||0);
      const loanAmt = round2(budget * (split/100));
      const btcAmt = round2(budget - loanAmt);
      document.getElementById('monthlyLoan').textContent = formatCurrency(loanAmt);
      document.getElementById('monthlyBTC').textContent = formatCurrency(btcAmt);
      const live = document.getElementById('splitLive');
      if(live){
        live.textContent = `Loan ${split}% / BTC ${round2(100 - split)}%`;
      }
    }

    function calc(){
      // derive numbers directly from controls
      const budget = Number(document.getElementById('budget').value||0);
      const split = Number(document.getElementById('split').value||0);
      const mLoan = round2(budget * (split/100));
      const mBTC  = round2(budget - mLoan);
      updateSplit();

      // Loan side
      const balance = Number(document.getElementById('balance').value||0);
      const loanStart = DEFAULT_YM; // current month
      const lump = Number(document.getElementById('lump').value||0);
      const L = calculateLoan(balance, mLoan, lump, loanStart);

      const loanRes = document.getElementById('loanResult');
      loanRes.hidden = false;
      if(L.error){
        document.getElementById('monthsOut').textContent = '—';
        document.getElementById('ymOut').innerHTML = '<span class="err">'+L.error+'</span>';
        document.getElementById('dateOut').textContent = '—';
        document.getElementById('paidOut').textContent = '—';
        document.getElementById('partialOut').textContent = '—';
        document.getElementById('monthlyLoanOut').textContent = '—';
      } else {
        document.getElementById('monthsOut').textContent = String(L.months);
        document.getElementById('ymOut').textContent = `${L.years} yrs ${L.extraMonths} mths`;
        document.getElementById('dateOut').textContent = L.payoffStr;
        document.getElementById('paidOut').textContent = formatCurrency(L.totalPaid);
        document.getElementById('partialOut').textContent = L.finalPartial ? formatCurrency(L.finalPartial) : '—';
        document.getElementById('monthlyLoanOut').textContent = formatCurrency(mLoan);
      }

      // BTC side — end aligned to loan payoff (fallback 12m if loan error)
      const btcStart = DEFAULT_YM; // current month
      let btcEndDate = (L && L.payoffDate instanceof Date) ? L.payoffDate : addMonths(new Date(`${btcStart}-01`), 12);
      const growth = Number(document.getElementById('btcGrowth').value||29);
      const B = calculateBTC(mBTC, growth, btcStart, btcEndDate);

      const btcRes = document.getElementById('btcResult');
      btcRes.hidden = false;
      document.getElementById('monthlyBTCOut').textContent = formatCurrency(mBTC);
      document.getElementById('btcMonths').textContent = String(B.months);
      const btcYears = Math.floor(B.months / 12);
      const btcExtraMonths = B.months % 12;
      document.getElementById('btcYM').textContent = `${btcYears} yrs ${btcExtraMonths} mths`;
      document.getElementById('btcDateOut').textContent = btcEndDate.toLocaleString(undefined,{month:'short',year:'numeric'});
      document.getElementById('btcContrib').textContent = formatCurrency(B.contrib);
      document.getElementById('btcGrowthOut').textContent = `${round2(growth)}% / yr`;
      document.getElementById('btcFV').textContent = formatCurrency(B.fv);

      // Net panel — compare on the chosen BTC horizon
      const horizonMonths = diffMonths(L.startDate, B.end);
      const paidByHorizon = loanPaidBy(balance, mLoan, lump, Math.max(0, horizonMonths));
      const netCombined = round2(paidByHorizon + B.fv);

      const netRes = document.getElementById('netResult');
      netRes.hidden = false;
      const loanCleared = (!L.error && horizonMonths >= L.months);
      document.getElementById('loanCleared').textContent = loanCleared ? 'Yes' : 'No';
      document.getElementById('netLoanPaid').textContent = formatCurrency(paidByHorizon);
      document.getElementById('netBTCVal').textContent = formatCurrency(B.fv);
      document.getElementById('netCombined').textContent = formatCurrency(netCombined);
    }

    // ---------- Listeners & presets ----------
    function setGrowthButtons(val){
      document.querySelectorAll('.growth-btn').forEach(btn => {
        const g = Number(btn.dataset.growth);
        btn.classList.toggle('active', Math.abs(g - val) < 0.001);
      });
    }

    document.getElementById('split').addEventListener('input', updateSplit);
    document.getElementById('budget').addEventListener('input', updateSplit);

    // Growth preset buttons
    document.querySelectorAll('.growth-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const v = Number(btn.dataset.growth);
        document.getElementById('btcGrowth').value = v;
        setGrowthButtons(v);
        calc();
      });
    });
    // Keep buttons in sync if user types a custom %
    document.getElementById('btcGrowth').addEventListener('input', () => {
      const v = Number(document.getElementById('btcGrowth').value||0);
      setGrowthButtons(v);
    });

    // One-tap 50/50 (auto-recalculate)
    document.getElementById('preset5050').addEventListener('click', () => {
      document.getElementById('split').value = 50;
      updateSplit();
      calc();
    });

    document.getElementById('calc').addEventListener('click', calc);
    document.getElementById('reset').addEventListener('click', () => {
      document.getElementById('budget').value = 250;
      document.getElementById('split').value = 50;

      document.getElementById('balance').value = 10000;
      document.getElementById('lump').value = 0;

      document.getElementById('btcGrowth').value = 29;
      setGrowthButtons(29);

      document.getElementById('loanResult').hidden = true;
      document.getElementById('btcResult').hidden = true;
      document.getElementById('netResult').hidden = true;
      updateSplit();
      calc();
    });

    // ---------- Self-tests ----------
    function runTests(){
      const tests = [
        { name:'LoanPaidBy: after 0 months equals lump only', fn: () => {
            const p = loanPaidBy(10000, 500, 1000, 0); return Math.abs(p - 1000) < 0.01; }
        },
        { name:'BTC: 0% growth ⇒ FV = contributions', fn: () => {
            const s = DEFAULT_YM; const e = ymStr(addMonths(new Date(`${s}-01`),12));
            const B = calculateBTC(200, 0, s, e);
            return Math.abs(B.fv - B.contrib) < 0.01; }
        },
        { name:'BTC: 12%/yr, 12m ⇒ annuity formula', fn: () => {
            const s = DEFAULT_YM; const e = ymStr(addMonths(new Date(`${s}-01`),12));
            const B = calculateBTC(100, 12, s, e);
            const i = 0.12/12; const n = 12; const expect = 100 * ((Math.pow(1+i,n)-1)/i);
            return Math.abs(B.fv - expect) < 0.01; }
        },
        { name:'Loan exact division: 1000 @ 250 ⇒ 4 months, no partial', fn: () => {
            const L = calculateLoan(1000, 250, 0, DEFAULT_YM);
            return L.months === 4 && Math.abs(L.finalPartial) < 1e-9; }
        },
        { name:'Loan partial final: 1000 @ 300 ⇒ 4 months, £100 final', fn: () => {
            const L = calculateLoan(1000, 300, 0, DEFAULT_YM);
            return L.months === 4 && Math.abs(L.finalPartial - 100) < 0.01; }
        }
      ];
      const out = [];
      let pass = 0;
      tests.forEach(t => {
        let ok = false;
        try { ok = !!t.fn(); } catch(e){ ok = false; }
        pass += ok ? 1 : 0;
        out.push(`<div class="${ok?'pass':'fail'}">${ok?'✔':'✖'} ${t.name}</div>`);
      });
      document.getElementById('testResults').innerHTML = `${pass}/${tests.length} passing` + out.join('');
    }

    // ---------- Init ----------
    updateSplit();
    calc();
    runTests();
    setGrowthButtons(Number(document.getElementById('btcGrowth').value||29));
  </script>
</body>
</html>
